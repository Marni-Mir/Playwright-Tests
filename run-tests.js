const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª —Å –ø–æ—Ä—è–¥–∫–æ–º —Ç–µ—Å—Ç–æ–≤
const orderFile = path.join(__dirname, 'test-order.json');
const order = JSON.parse(fs.readFileSync(orderFile, 'utf-8'));

// –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
const category = process.argv[2];

if (!category) {
  console.log('‚ùå –£–∫–∞–∂–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–µ—Å—Ç–æ–≤!');
  console.log('\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
  Object.keys(order).forEach(cat => {
    console.log(`  - ${cat} (${order[cat].length} —Ç–µ—Å—Ç–æ–≤)`);
  });
  console.log('\n–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:');
  console.log('  node run-tests.js smoke');
  console.log('  node run-tests.js pto');
  process.exit(1);
}

if (!order[category]) {
  console.log(`‚ùå –ö–∞—Ç–µ–≥–æ—Ä–∏—è "${category}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);
  console.log(`\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${Object.keys(order).join(', ')}`);
  process.exit(1);
}

const testFiles = order[category];
console.log(`üöÄ –ó–∞–ø—É—Å–∫–∞—é ${testFiles.length} —Ç–µ—Å—Ç–æ–≤ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${category}"...\n`);
console.log('‚ÑπÔ∏è  Retry –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Playwright (2 –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Ç–µ—Å—Ç–∞)\n');

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
let passed = 0;
let failed = 0;

for (let i = 0; i < testFiles.length; i++) {
  const file = testFiles[i];
  const isFirstTest = i === 0; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç?
  
  try {
    console.log(`\n[${i + 1}/${testFiles.length}] –ó–∞–ø—É—Å–∫–∞—é: ${file}`);
    if (isFirstTest) {
      console.log('‚ö†Ô∏è  –≠—Ç–æ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç - –µ—Å–ª–∏ –æ–Ω —É–ø–∞–¥—ë—Ç, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ –∑–∞–ø—É—Å—Ç—è—Ç—Å—è');
    }
    console.log('‚îÄ'.repeat(50));
    
    try {
      execSync(
        `npx playwright test ${file} --config ..\\playwright.config.js --workers=1 --reporter=list,html`,
        { 
          stdio: 'inherit',
          cwd: __dirname,
          timeout: 1800000, // 30 –º–∏–Ω—É—Ç –Ω–∞ —Ç–µ—Å—Ç
          env: {
            ...process.env,
            // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ HTML-–æ—Ç—á—ë—Ç–∞ (CI —Ä–µ–∂–∏–º)
            // Playwright retry –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
            CI: 'true'
          }
        }
      );
      passed++;
      console.log(`\n‚úÖ ${file} - –£–°–ü–ï–®–ù–û`);
    } catch (error) {
      failed++;
      console.log(`\n‚ùå ${file} - –ü–†–û–í–ê–õ–ï–ù`);
      if (error.status !== undefined) {
        console.log(`   –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: ${error.status}`);
      }
      
      // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
      if (isFirstTest) {
        console.log(`\nüõë –ü–ï–†–í–´–ô –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.`);
        console.log(`   –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞.`);
        break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
      } else {
        console.log(`   ‚è≠Ô∏è  –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ—Å—Ç–æ–º...`);
      }
    }
    
    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç –∏ –Ω–µ –ø–µ—Ä–≤—ã–π —É–ø–∞–ª)
    if (i < testFiles.length - 1 && !(isFirstTest && failed > 0)) {
      console.log('\n‚è≥ –ü–∞—É–∑–∞ 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ—Å—Ç–æ–º...\n');
      const start = Date.now();
      while (Date.now() - start < 2000) {
        // –ü—Ä–æ—Å—Ç–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥—ã
      }
    }
  } catch (unexpectedError) {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
    console.log(`\n‚ö†Ô∏è  –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ${file}: ${unexpectedError.message}`);
    failed++;
    
    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    if (isFirstTest) {
      console.log(`\nüõë –ü–ï–†–í–´–ô –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù! –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.`);
      console.log(`   –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–µ –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞.`);
      break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
    } else {
      console.log(`   ‚è≠Ô∏è  –ü—Ä–æ–¥–æ–ª–∂–∞—é —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ—Å—Ç–æ–º...`);
    }
  }
}

console.log('\n' + '='.repeat(50));
console.log(`üìä –ò—Ç–æ–≥–æ: ${passed} —É—Å–ø–µ—à–Ω–æ, ${failed} –ø—Ä–æ–≤–∞–ª–µ–Ω–æ –∏–∑ ${testFiles.length}`);
console.log('='.repeat(50));

// –°–æ–±–∏—Ä–∞–µ–º –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º HTML-–æ—Ç—á—ë—Ç –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
console.log('\nüìä –ò—Ç–æ–≥–æ–≤—ã–π HTML-–æ—Ç—á—ë—Ç:\n');
console.log('   –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: PW/test-results/');
console.log('   –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–≥–æ HTML-–æ—Ç—á—ë—Ç–∞ —Å–æ –≤—Å–µ–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∑–∞–ø—É—Å—Ç–∏:');
console.log('   npx playwright show-report');
console.log('\n   –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–æ–±–µ—Ä—ë—Ç –æ—Ç—á—ë—Ç –∏–∑ –≤—Å–µ—Ö test-results –∏ –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã.\n');

// –í—ã—Ö–æ–¥–∏–º —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –±—ã–ª–∏ –ø—Ä–æ–≤–∞–ª—ã
if (failed > 0) {
  process.exit(1);
}

